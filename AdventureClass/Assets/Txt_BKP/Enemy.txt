using Assets.Script.Enums;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.AI;

public class WarZombieBehavior : MonoBehaviour
{
    [SerializeField] EnumZombieActionState zombieActionState = EnumZombieActionState.Patrol;
    //Patrol
    [Header("Patrulha")]
    [SerializeField] float waitingTime;
    [SerializeField] Transform[] waypoint;
    WaitForSeconds waitinOnWayPoint;
    int index;
    bool isAlive = true;
    [Header("Perseguir jogador")]
    //ChasePlayer
    GameObject player;
    [SerializeField] float chaseStartDistance;
    [Header("Atacar Jogador")]
    [SerializeField] float attackDistance;



    NavMeshAgent navMeshAgent;
    Animator animator;

    // Start is called before the first frame update
    void Start()
    {
        player = GameObject.FindGameObjectWithTag("Player");
        navMeshAgent = gameObject.GetComponent<NavMeshAgent>();
        animator = GetComponent<Animator>();
        waitinOnWayPoint = new WaitForSeconds(waitingTime);
        index = Random.Range(0, waypoint.Length);
        StartCoroutine(Patrol());
    }

    // Update is called once per frame
    void Update()
    {
        if (player == null){ Debug.LogError("Player Nulo!"); return; }

        if (zombieActionState == EnumZombieActionState.Patrol)
        {
            navMeshAgent.speed = 1.0f;
            animator.SetFloat("Move", Mathf.Clamp(navMeshAgent.velocity.sqrMagnitude, 0, 0.5f), 0.06f, Time.deltaTime);
            animator.speed = 1.0f;
        }
        ChasePlayer();
        AttackPlayer();

    }

    IEnumerator Patrol()
    {
        while (isAlive)
        {
            if (zombieActionState == EnumZombieActionState.Patrol)
            {
                navMeshAgent.SetDestination(waypoint[index].position);
                index = index == waypoint.Length - 1 ? 0 : index + 1;
            }
            yield return waitinOnWayPoint;
        }
       

    }
    void ChasePlayer()
    {
        if (player == null) { return; }

        if(Vector3.Distance(transform.position, player.transform.position) <= chaseStartDistance && Vector3.Distance(transform.position, player.transform.position) > attackDistance)
        {
            zombieActionState = EnumZombieActionState.ChasingPlayer;
            animator.SetFloat("Move", 1.0f, 0.06f, Time.deltaTime);
            animator.speed = 1.5f;
            navMeshAgent.speed = 2.5f;
            navMeshAgent.SetDestination(player.transform.position);
        }
      if(Vector3.Distance(transform.position, player.transform.position) > chaseStartDistance)
        {
            zombieActionState = EnumZombieActionState.Patrol;
        }

    }
    void AttackPlayer()
    {
        if (player == null) { return; }
        if (Vector3.Distance(transform.position, player.transform.position) <= attackDistance)
        {
            zombieActionState = EnumZombieActionState.AttackPlayer;
            animator.SetTrigger("Attack");           
            navMeshAgent.speed = 0.0f;
        }

    }
    void PatrolArea()
    {

    }
    void StateMannager(float distance)
    {
        if (distance > chaseStartDistance)
        {
            zombieActionState = EnumZombieActionState.Patrol;
        }else if (distance <= chaseStartDistance && distance > attackDistance)
        {
            zombieActionState = EnumZombieActionState.ChasingPlayer;
        }else if (distance<=attackDistance)
        {
            zombieActionState = EnumZombieActionState.AttackPlayer;
        }
    }
}


